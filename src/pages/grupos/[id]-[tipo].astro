---
import GroupDetails from '../../components/GroupDetails';
import RecaudacionDisplay from '../../components/recaudacion';
import Layout from '../../layouts/Layout.astro';
import '../../styles/modal.css'
import '../../styles/yellowBtn.css'
import '../../styles/global.css'
import CerrarSesion from '../../components/cerrarsesion';

const { id, tipo } = Astro.params;
---

<Layout title="Welcome to Splithive">
    <main>
        <CerrarSesion client:only></CerrarSesion>
        {tipo === "gastos" && (<GroupDetails client:only id={id}></GroupDetails>)}
        {tipo === "recaudación" && (<RecaudacionDisplay client:only id={id}></RecaudacionDisplay>)}

        <button id="crearGastoBtn" class="yellowBtn">Crear gasto</button>

        <div id="modal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close" id="closeModal">&times;</span>
                <img src='/public/images/bee.png' alt="Bees" style="width: 100px; "/>

                <form id="crearGastoFormulario">

                    <div class="form-group">
                        <label for="nombreGasto">Nombre del gasto:</label>
                        <input type="text" id="nombreGasto" name="nombreGasto" class="input-field">
                    </div>

                    <div class="form-group">
                        <label for="montoGasto ">Monto:</label>
                        <input type="number" step="0.01" min="0" id="montoGasto" name="montoGasto">
                    </div>

                    <div class="form-group">
                        <label for="dropdown">Quien Pagó:</label>
                        <select id="quienPago">
                        </select>
                    </div>

                    <div id="deudoresContainer"></div>
                    <!-- <button type="button" id="agregarDeudorBtn">+</button><br><br> -->
                    <div style="margin-top: 10px;">
                        <button class="submitBtn" type="submit">Crear</button>
                        <button class="cancelarBtn" id="cerrarFormBtn" type="button">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>

        <p id="gruopId" style="display: none;">{id}</p>
        <script>
            import { getContactos, getUsuarios, getGrupos, getGastos, getHives, getCurrentUser, getInvitados } from "../../utils/utilities"

            var currentDate = new Date();

            // Getting the current date components
            var year = currentDate.getFullYear();
            var month = currentDate.getMonth() + 1; // Months are zero-based, so January is 0
            var day = currentDate.getDate();
            var fechaActual =(day < 10 ? "0" + day : day) + "-"+(month < 10 ? "0" + month : month) + "-" + year;
            var grupos = getGrupos();
            var currentUser = getCurrentUser();
            var usuarios = getUsuarios();
            var invitados = getInvitados();

            var modal = document.getElementById('modal');
            var btnAbrirModal = document.getElementById('crearGastoBtn');
            var spanCerrar = document.getElementById('closeModal');

            btnAbrirModal.onclick = function() {
                var usuarios = getUsuarios()
                modal.style.display = 'block';

                var deudores = document.getElementById('deudoresContainer');
                if (deudores.innerHTML != '') {
                    return;
                }
                var integrantes = grupos[+document.getElementById('gruopId').innerText].integrantes;

                var dropdown = document.getElementById("quienPago")

                integrantes.forEach(function(integrante, i) {
                    var checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = 'deudor' + integrante;
                    checkbox.name = 'deudor' + integrante;
                    var label = document.createElement('label');
                    label.htmlFor = 'deudor' + integrante;
                    label.textContent = usuarios[integrante].nombre;
                    var container = document.createElement('div');
                    container.classList.add("deudor-checkbox");
                    container.appendChild(checkbox);
                    container.appendChild(label);
                    deudores.appendChild(container);
                    if (integrante == currentUser) {
                        checkbox.checked = true;
                        checkbox.disabled = true;
                    }
                    var optionElement = document.createElement("option");
                    optionElement.value = integrante;
                    optionElement.textContent = usuarios[integrante].nombre;
                    dropdown.appendChild(optionElement)
                });

                var grupo = grupos[+document.getElementById('gruopId').innerText];

                if (grupo.invitados) {
                    grupo.invitados.forEach(function(integrante, i) {
                    var checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = 'invitado' + integrante;
                    checkbox.name = 'invitado' + integrante;
                    var label = document.createElement('label');
                    label.htmlFor = 'invitado' + integrante;
                    label.textContent = invitados[integrante].nombre + " (invitado)";
                    label.classList.add("label-invitado")
                    var container = document.createElement('div');
                    container.classList.add("deudor-checkbox");
                    container.appendChild(checkbox);
                    container.appendChild(label);
                    deudores.appendChild(container);
                });
                }
            };

            spanCerrar.onclick = function() {
                modal.style.display = 'none';
            };

            window.onclick = function(event) {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            };


            document.getElementById('cerrarFormBtn').addEventListener('click', function() {
                document.getElementById('modal').style.display = 'none';
            });

            //var contadorDeudores = 0; 

            // document.getElementById('agregarDeudorBtn').addEventListener('click', function() {
            //     contadorDeudores++; 
            //     var deudoresContainer = document.getElementById('deudoresContainer');
            //     var nuevoCampoDeudor = document.createElement('div');
            //     nuevoCampoDeudor.innerHTML = `<label for="nombreDeudor${contadorDeudores}">Nombre del deudor ${contadorDeudores}:</label>
            //                                     <input type="text" id="nombreDeudor${contadorDeudores}" name="nombreDeudor${contadorDeudores}"><br><br>`;
            //     deudoresContainer.appendChild(nuevoCampoDeudor);
            // });

//            { nombre: "colegio", deuda: 80, deudores: ["Raul"] } 

            document.getElementById('crearGastoFormulario').addEventListener('submit', function(event) {
                event.preventDefault(); 
                if (document.getElementById('nombreGasto').value == '' || document.getElementById('montoGasto').value == '') {
                    alert('Por favor complete todos los campos');
                    return;
                }

                var nombreGasto = document.getElementById('nombreGasto').value;
                var monto = +document.getElementById('montoGasto').value;
                var quienPago = document.getElementById("quienPago").value;
                var deudores = [];
                var invitadosDeudores = []
                var id = +document.getElementById('gruopId').innerText;
                
                grupos[id].integrantes.forEach(function(integrante) {
                    if (document.getElementById('deudor' + integrante).checked) {
                        deudores.push(integrante);
                    }
                });

                if (grupos[id].invitados) {
                    grupos[id].invitados.forEach(function(integrante) {
                        if (document.getElementById('invitado' + integrante).checked) {
                            invitadosDeudores.push(integrante);
                        }
                    });
                }

                var total = monto;
                monto = Math.round((monto / deudores.length) * 100) / 100;
                var repartos = {};
                var invitadosReparto = {};
                deudores.forEach(deudor => {
                    repartos[deudor] = monto
                })
                if (grupos[id].invitados) {
                    invitadosDeudores.forEach(deudor => {
                        invitadosReparto[deudor] = monto
                    })
                }
                var currentDate = new Date();

                // Getting the current date components
                var year = currentDate.getFullYear();
                var month = currentDate.getMonth() + 1; // Months are zero-based, so January is 0
                var day = currentDate.getDate();
                var fechaActual =(day < 10 ? "0" + day : day)+"-"+(month < 10 ? "0" + month : month) + "-" + year;
                var nuevoGasto = { nombre: nombreGasto, monto: total,fecha:fechaActual,payer: quienPago, deudores: deudores, reparto: repartos };

                if (grupos[id].invitados) {
                    nuevoGasto.invitados = invitadosReparto
                }
                
                var gastos = getGastos()
                var mapa_gastos = new Map();
                var maximo = 0;
                for (const key in gastos){
                    if (gastos.hasOwnProperty(key)){
                        if (Number(key) > Number(maximo)){
                            maximo = Number(key);
                        }
                    }
                }
                const highestValue = Math.max(...mapa_gastos.keys());
                gastos[maximo+1] = nuevoGasto
                var grupo = grupos[id]
                grupo.gastos.push(maximo+1)
                grupos[id] = grupo
                sessionStorage.setItem("grupos",JSON.stringify(grupos))
                sessionStorage.setItem('gastos', JSON.stringify(gastos));
                modal.style.display = 'none'; 
                document.getElementById('crearGastoFormulario').reset();
                location.reload();
            });
        </script>
    </main>
</Layout>

<style is:global>

    #gastos {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
    }
    .gasto-card {
        background-color: honeydew;
        border-radius: 8px;
        padding: 20px;
        width: calc(33.33% - 20px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease-in-out;
        text-decoration: none;
        color: inherit;
    }
    .gasto-card:hover {
        transform: translateY(-5px);
    }
    .gasto-card h2 {
        margin-top: 0;
        color: black;
    }
    .gasto-card p {
        margin: 0;
        color: grey;
    }

	.instructions {
		margin-bottom: 2rem;
		border: 1px solid rgba(var(--accent-light), 25%);
		background: linear-gradient(rgba(var(--accent-dark), 66%), rgba(var(--accent-dark), 33%));
		padding: 1.5rem;
		border-radius: 8px;
	}
	.instructions code {
		font-size: 0.8em;
		font-weight: bold;
		background: rgba(var(--accent-light), 12%);
		color: rgb(var(--accent-light));
		border-radius: 4px;
		padding: 0.3em 0.4em;
	}
	.instructions strong {
		color: rgb(var(--accent-light));
	}
	.link-card-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(24ch, 1fr));
		gap: 2rem;
		padding: 0;
	}

    .deudor-checkbox {
        display: inline-block;
        margin-right: 10px; /* Adjust as needed */
    }

    .label-invitado {
        color: green;
    }

    #agregarDeudorBtn {
        background-color: #F6F1E9;  
        color: black; 
    }

    #crearGastoFormulario {
        margin-top: 40px;
    }


    input:disabled {
        background-color: transparent;
    }

    input {
        background-color: wheat; 
        border: 3px; border-color: black; 
        border-radius: 5px;
    }

    #quienPago {
    padding: 8px;
    font-size: 16px;
    border: 1px solid #ccc;
    border-radius: 4px;
    color: #333
    }

    #quienPago option {
    padding: 8px;
    font-size: 16px;
    background-color: #f9f9f9;
    color: #333;
    }

    #quienPago option:checked {
    background-color: #007bff;
    color: #030303;
    }
</style>